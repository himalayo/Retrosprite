name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
        shell: bash

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install
        shell: bash

      - name: Extract version from tag
        id: get_version
        shell: bash
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="1.0.0"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Update version in files
        shell: bash
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          # Update wails.json
          sed -i 's/"version": "[^"]*"/"version": "'"$VERSION"'"/' wails.json
          sed -i 's/"productVersion": "[^"]*"/"productVersion": "'"$VERSION"'"/' wails.json

          # Update NSIS installer
          IFS='.' read -r MAJOR MINOR BUILD <<< "$VERSION"
          sed -i "s/!define VERSIONMAJOR .*/!define VERSIONMAJOR $MAJOR/" build/windows/installer.nsi
          sed -i "s/!define VERSIONMINOR .*/!define VERSIONMINOR $MINOR/" build/windows/installer.nsi
          sed -i "s/!define VERSIONBUILD .*/!define VERSIONBUILD $BUILD/" build/windows/installer.nsi

      - name: Build Windows application
        shell: bash
        run: wails build -platform windows/amd64 -ldflags "-X main.Version=${{ steps.get_version.outputs.VERSION }}"

      - name: Setup NSIS
        run: choco install nsis -y

      - name: Build Windows Installer
        run: |
          # Add NSIS to PATH and build installer
          $env:Path += ";C:\Program Files (x86)\NSIS"
          makensis build/windows/installer.nsi

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            Retrosprite-Installer.exe
            build/bin/Retrosprite.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Extract version from tag
        id: get_version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="1.0.0"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Update version in wails.json
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          sed -i '' "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" wails.json
          sed -i '' "s/\"productVersion\": \"[^\"]*\"/\"productVersion\": \"$VERSION\"/" wails.json

      - name: Build macOS application
        run: wails build -platform darwin/universal -ldflags "-X main.Version=${{ steps.get_version.outputs.VERSION }}"

      - name: Create DMG
        run: |
          # Install create-dmg
          brew install create-dmg

          # Create DMG
          create-dmg \
            --volname "Retrosprite" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "Retrosprite-${{ steps.get_version.outputs.VERSION }}-macOS.dmg" \
            "build/bin/Retrosprite.app" || true

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            Retrosprite-*.dmg

  build-linux:
    runs-on: ubuntu-latest
    if: false  # Temporarily disabled - uncomment when ready to add Linux support
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Extract version from tag
        id: get_version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="1.0.0"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Update version in wails.json
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" wails.json
          sed -i "s/\"productVersion\": \"[^\"]*\"/\"productVersion\": \"$VERSION\"/" wails.json

      - name: Build Linux application
        run: wails build -platform linux/amd64 -ldflags "-X main.Version=${{ steps.get_version.outputs.VERSION }}"

      - name: Install AppImage tools
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppImage
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy binary
          cp build/bin/Retrosprite AppDir/usr/bin/

          # Create desktop file
          cat > AppDir/usr/share/applications/retrosprite.desktop << EOF
          [Desktop Entry]
          Name=Retrosprite
          Exec=Retrosprite
          Icon=retrosprite
          Type=Application
          Categories=Utility;
          EOF

          # Copy icon (assuming you have a PNG icon)
          cp frontend/src/assets/retrosprite_icon.png AppDir/usr/share/icons/hicolor/256x256/apps/retrosprite.png || true

          # Create AppImage
          ./appimagetool-x86_64.AppImage AppDir Retrosprite-${{ steps.get_version.outputs.VERSION }}-x86_64.AppImage

      - name: Build DEB package
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          mkdir -p deb-package/DEBIAN
          mkdir -p deb-package/usr/bin
          mkdir -p deb-package/usr/share/applications
          mkdir -p deb-package/usr/share/icons/hicolor/256x256/apps

          # Copy binary
          cp build/bin/Retrosprite deb-package/usr/bin/

          # Copy desktop file
          cp AppDir/usr/share/applications/retrosprite.desktop deb-package/usr/share/applications/

          # Copy icon
          cp frontend/src/assets/retrosprite_icon.png deb-package/usr/share/icons/hicolor/256x256/apps/retrosprite.png || true

          # Create control file
          cat > deb-package/DEBIAN/control << EOF
          Package: retrosprite
          Version: $VERSION
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Bopified <Bopified@proton.me>
          Description: Habbo Furniture Asset Editor
           A powerful tool for editing and converting furniture bundles for Habbo retro hotels.
          EOF

          # Build deb
          dpkg-deb --build deb-package retrosprite_${VERSION}_amd64.deb

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            Retrosprite-*.AppImage
            retrosprite_*.deb

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract version
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/windows-build/Retrosprite-Installer.exe
            artifacts/macos-build/Retrosprite-*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
